<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QZ Tray Receipt Printing Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        code {
            background: #f4f4f4;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class='container'>
        <h1>üñ®Ô∏è QZ Tray Receipt Printing Setup</h1>
        <p>This setup allows online POS to print receipts directly to local thermal printer.</p>
        
        <div class="step">
            <h3>Step 1: Install QZ Tray</h3>
            <p>Download and install QZ Tray from: <a href="https://qz.io/download/" target="_blank">https://qz.io/download/</a></p>
            <button onclick="checkQZTray()">Check QZ Tray Status</button>
            <div id="qz-status"></div>
        </div>
        
        <div class="step">
            <h3>Step 2: Test Receipt Printing</h3>
            <p>Test if QZ Tray can print to your thermal printer.</p>
            <button onclick="testPrint()">Test Print Receipt</button>
            <div id="print-status"></div>
        </div>
        
        <div class="step">
            <h3>Step 3: Configure Printer</h3>
            <p>Select your thermal printer from the list below.</p>
            <button onclick="listPrinters()">List Available Printers</button>
            <div id="printer-list"></div>
        </div>
        
        <div class="step">
            <h3>Step 4: Integration with POS</h3>
            <p>Copy the JavaScript code below to your POS system.</p>
            <pre id="integration-code"></pre>
            <button onclick="copyCode()">Copy Code</button>
        </div>
    </div>

    <!-- QZ Tray JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@3.0.0/dist/qz-tray.min.js"></script>
    
    <script>
        // QZ Tray configuration
        const qzConfig = {
            host: 'localhost',
            port: 9999,
            secure: false
        };
        
        let selectedPrinter = 'POS-58'; // Default printer
        
        // Check QZ Tray status
        async function checkQZTray() {
            const statusDiv = document.getElementById('qz-status');
            statusDiv.innerHTML = '<p>Checking QZ Tray status...</p>';
            
            try {
                const response = await fetch('http://localhost:9999/api/version');
                if (response.ok) {
                    const version = await response.text();
                    statusDiv.innerHTML = `<p class="success">‚úÖ QZ Tray is running! Version: ${version}</p>`;
                } else {
                    statusDiv.innerHTML = '<p class="error">‚ùå QZ Tray is not running. Please install and start QZ Tray.</p>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<p class="error">‚ùå QZ Tray is not running. Please install and start QZ Tray.</p>';
            }
        }
        
        // List available printers
        async function listPrinters() {
            const listDiv = document.getElementById('printer-list');
            listDiv.innerHTML = '<p>Loading printers...</p>';
            
            try {
                const response = await fetch('http://localhost:9999/api/printers');
                if (response.ok) {
                    const printers = await response.json();
                    let html = '<h4>Available Printers:</h4><ul>';
                    printers.forEach(printer => {
                        html += `<li><button onclick="selectPrinter('${printer}')">${printer}</button></li>`;
                    });
                    html += '</ul>';
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p class="error">‚ùå Cannot list printers. QZ Tray may not be running.</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p class="error">‚ùå Cannot list printers. QZ Tray may not be running.</p>';
            }
        }
        
        // Select printer
        function selectPrinter(printer) {
            selectedPrinter = printer;
            document.getElementById('printer-list').innerHTML += `<p class="success">‚úÖ Selected printer: ${printer}</p>`;
        }
        
        // Test print receipt
        async function testPrint() {
            const statusDiv = document.getElementById('print-status');
            statusDiv.innerHTML = '<p>Testing print...</p>';
            
            try {
                // Get receipt data from PHP
                const response = await fetch('qz-tray-receipt.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: '2024-01-15',
                        time: '14:30:00',
                        transactionId: 'TEST123',
                        cashier: 'Test User',
                        terminalName: 'POS',
                        items: [
                            { name: 'Test Item 1', quantity: 1, price: 10.00 },
                            { name: 'Test Item 2', quantity: 2, price: 15.00 }
                        ],
                        subtotal: 40.00,
                        grandTotal: 40.00,
                        paymentMethod: 'CASH',
                        amountPaid: 50.00,
                        change: 10.00
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Send to QZ Tray
                        const printResponse = await fetch('http://localhost:9999/api/print', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                printer: selectedPrinter,
                                data: result.data.receipt,
                                options: {
                                    copies: 1,
                                    orientation: 'portrait'
                                }
                            })
                        });
                        
                        if (printResponse.ok) {
                            statusDiv.innerHTML = '<p class="success">‚úÖ Receipt printed successfully!</p>';
                        } else {
                            statusDiv.innerHTML = '<p class="error">‚ùå Print failed. Check QZ Tray and printer.</p>';
                        }
                    } else {
                        statusDiv.innerHTML = '<p class="error">‚ùå Receipt generation failed: ' + result.message + '</p>';
                    }
                } else {
                    statusDiv.innerHTML = '<p class="error">‚ùå Cannot get receipt data from PHP.</p>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<p class="error">‚ùå Print test failed: ' + error.message + '</p>';
            }
        }
        
        // Generate integration code
        function generateIntegrationCode() {
            const code = `
// QZ Tray Receipt Printing Integration
async function printReceiptViaQZTray(receiptData) {
    try {
        // Get receipt data from PHP
        const response = await fetch('qz-tray-receipt.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(receiptData)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Send to QZ Tray
                const printResponse = await fetch('http://localhost:9999/api/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        printer: '${selectedPrinter}',
                        data: result.data.receipt,
                        options: {
                            copies: 1,
                            orientation: 'portrait'
                        }
                    })
                });
                
                if (printResponse.ok) {
                    console.log('‚úÖ Receipt printed successfully!');
                    return { success: true, message: 'Receipt printed successfully!' };
                } else {
                    console.log('‚ùå Print failed. Check QZ Tray and printer.');
                    return { success: false, message: 'Print failed. Check QZ Tray and printer.' };
                }
            } else {
                console.log('‚ùå Receipt generation failed: ' + result.message);
                return { success: false, message: result.message };
            }
        } else {
            console.log('‚ùå Cannot get receipt data from PHP.');
            return { success: false, message: 'Cannot get receipt data from PHP.' };
        }
    } catch (error) {
        console.log('‚ùå Print error: ' + error.message);
        return { success: false, message: error.message };
    }
}

// Usage in POS system:
// const printResult = await printReceiptViaQZTray(receiptData);
// if (printResult.success) {
//     console.log('Receipt printed successfully!');
// } else {
//     console.log('Print failed: ' + printResult.message);
// }
            `;
            
            document.getElementById('integration-code').textContent = code;
        }
        
        // Copy code to clipboard
        function copyCode() {
            const code = document.getElementById('integration-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }
        
        // Initialize
        window.onload = function() {
            generateIntegrationCode();
            checkQZTray();
        };
    </script>
</body>
</html>
